{% extends 'base.html' %}
{% block content %}
<div class="row">
	<div id="sidebarCol" class="col-12 col-md-3 mb-3 opacity-transition grow-width">
		<div class="card shadow-sm mb-3 slide-in-left">
			<div class="card-body">
				<h6 class="mb-2">Your Profile</h6>
				<div class="small text-muted">Gender: {{ (current_user.profile.gender if current_user.is_authenticated and current_user.profile else '—') }}</div>
				<div class="small text-muted">Age: {{ (current_user.profile.age if current_user.is_authenticated and current_user.profile else '—') }}</div>
				<div class="small text-muted">Interests: {{ (current_user.profile.interests if current_user.is_authenticated and current_user.profile else '—') }}</div>
				<div class="mt-2"><a class="btn btn-sm btn-outline-info" href="{{ url_for('profile.me') }}">Edit</a></div>
			</div>
		</div>
		<h5>Region: <span class="badge text-bg-secondary">{{ region }}</span></h5>
		<ul class="list-group shadow-sm">
			{% for r in rooms %}
			<li class="list-group-item d-flex justify-content-between align-items-center">
				<span class="fw-medium">{{ r }}</span>
				<button class="btn btn-sm btn-outline-primary" onclick="switchToRoom('{{ r }}')">Join</button>
			</li>
			{% endfor %}
		</ul>
		<div class="mt-3 d-grid gap-2">
			<a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.region') }}">Change region</a>
			<button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#createRoomModal">Create room</button>
			<form class="input-group input-group-sm" onsubmit="event.preventDefault(); joinByCode(this.code.value); this.reset();">
				<input name="code" class="form-control" placeholder="Enter room code">
				<button class="btn btn-primary" type="submit">Join</button>
			</form>
			{% if group_code %}
			<form method="post" action="{{ url_for('groups.leave_group') }}">
				<button class="btn btn-sm btn-outline-danger w-100" type="submit">Leave room {{ group_code }}</button>
			</form>
			{% endif %}
		</div>
	</div>
	<div id="chatCol" class="col-12 col-md-9 grow-width">
		<div class="card shadow-sm chat-card">
			<div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
				<div class="d-flex align-items-center gap-2">
					<button id="backBtn" class="btn btn-sm btn-outline-secondary d-none" onclick="leaveCurrent()">Back</button>
					<div>
						Room: <span id="roomName" class="fw-semibold">None</span>
						<span id="onlineBadge" class="badge text-bg-success ms-2 d-none"><i class="bi bi-people-fill me-1"></i><span id="onlineCount">0</span> online</span>
						{% if group_code %}
							<span class="badge text-bg-info ms-2">{{ group_name or 'Room' }} · Code {{ group_code }}</span>
						{% endif %}
					</div>
				</div>
				<form class="d-flex align-items-center gap-2" method="post" action="{{ url_for('main.set_nickname') }}">
					<input name="nickname" class="form-control form-control-sm" value="{{ nickname }}" style="max-width: 180px;" required>
					<button class="btn btn-sm btn-outline-primary" type="submit">Update</button>
				</form>
			</div>
			<div id="messages" class="card-body chat-body"></div>
			<div class="card-footer">
				<div class="mb-2 d-flex flex-wrap gap-1">
					<button class="btn btn-sm btn-light" onclick="insertEmoji('👍')">👍</button>
					<button class="btn btn-sm btn-light" onclick="insertEmoji('❤️')">❤️</button>
					<button class="btn btn-sm btn-light" onclick="insertEmoji('😂')">😂</button>
					<button class="btn btn-sm btn-light" onclick="insertEmoji('🔥')">🔥</button>
					<button class="btn btn-sm btn-light" onclick="insertEmoji('🙏')">🙏</button>
				</div>
				<div id="typing" class="text-muted small mb-2" style="min-height:1rem"></div>
				<div class="input-group">
					<input id="messageInput" class="form-control" placeholder="Type a message...">
					<button class="btn btn-primary" onclick="sendMessage()">Send</button>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Create Room Modal -->
<div class="modal fade" id="createRoomModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form method="post" action="{{ url_for('groups.create_group') }}">
				<div class="modal-header">
					<h5 class="modal-title">Create Room</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="form-floating">
						<input name="name" class="form-control" id="gname" placeholder="Room name" required>
						<label for="gname">Room name</label>
					</div>
					<p class="small text-muted mt-2 mb-0">A unique room code will be generated.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-success">Create</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
window.region = "{{ region }}";
window.nickname = "{{ nickname }}";
window.groupCode = {{ group_code|tojson }};
function switchToRoom(name){ window.groupCode = null; document.getElementById('messages').innerHTML=''; joinRoom(name); }
if (!window.groupCode) { setTimeout(() => { switchToRoom('{{ rooms[0] }}'); }, 0); }
if (window.groupCode) { setTimeout(() => { document.getElementById('messages').innerHTML=''; joinByCode(window.groupCode); }, 0); }
</script>
{% endblock %}
